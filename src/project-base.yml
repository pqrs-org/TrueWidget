name: TrueWidget

options:
  bundleIdPrefix: org.pqrs
packages:
  # We have to declare all packages in project-base.yml instead of separated in project-base.yml and project-with-codesign.yml to avoid `Could not resolve package dependencies` error,
  # when the codesign requirement is changed between builds.
  # (For example, the first build is with codesign, then the second build is without codesign.)
  AsyncAlgorithms:
    url: https://github.com/apple/swift-async-algorithms
    from: 1.0.0
  SettingsAccess:
    url: https://github.com/orchetect/SettingsAccess
    from: 2.1.0
  Sparkle:
    url: https://github.com/sparkle-project/Sparkle
    from: 2.8.1

targets:
  TrueWidget:
    type: application
    platform: macOS
    deploymentTarget: '13.0'
    sources:
      - path: TrueWidget
        excludes:
          - 'Info.plist.in'
      - path: Helper/HelperProtocol.swift
      - path: PrivilegedHelper/PrivilegedDaemon/PrivilegedDaemonProtocol.swift
    settings:
      base:
        ASSETCATALOG_COMPILER_APPICON_NAME: ''
        OTHER_SWIFT_FLAGS: '-warnings-as-errors'
        DEAD_CODE_STRIPPING: 'YES'
        SWIFT_VERSION: '6.0'
    dependencies:
      - package: AsyncAlgorithms
      - package: SettingsAccess
      - target: TrueWidget Helper

  TrueWidget Helper:
    type: xpc-service
    platform: macOS
    deploymentTarget: '13.0'
    sources:
      - path: Helper
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: org.pqrs.TrueWidget.Helper
        LD_RUNPATH_SEARCH_PATHS:
          - '$(inherited)'
          - '@loader_path/../../../../Frameworks'
        OTHER_SWIFT_FLAGS: '-warnings-as-errors'
        DEAD_CODE_STRIPPING: 'YES'
        SWIFT_VERSION: '6.0'

  TrueWidget Privileged Helper:
    type: application
    platform: macOS
    deploymentTarget: '13.0'
    sources:
      - path: PrivilegedHelper/Info.plist
      - path: PrivilegedHelper/src
      - path: TrueWidget/app.icns
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: org.pqrs.TrueWidget.PrivilegedHelper
        OTHER_SWIFT_FLAGS: '-warnings-as-errors'
        DEAD_CODE_STRIPPING: 'YES'
        SWIFT_VERSION: '6.0'
        # SMAppService requires codesigning
        CODE_SIGN_ENTITLEMENTS: ''
        CODE_SIGN_IDENTITY: 'Apple Development'
        CODE_SIGN_STYLE: Automatic
        # Sign to Run Locally
        CODE_SIGN_IDENTITY[sdk=macosx*]: '-'
    dependencies:
      - target: TrueWidget Privileged Daemon

  TrueWidget Privileged Daemon:
    type: tool
    platform: macOS
    deploymentTarget: '13.0'
    sources:
      - path: PrivilegedHelper/PrivilegedDaemon
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: org.pqrs.TrueWidget.PrivilegedDaemon
        INFOPLIST_FILE: 'PrivilegedHelper/PrivilegedDaemon/Info.plist'
        CREATE_INFOPLIST_SECTION_IN_BINARY: 'YES'
        OTHER_SWIFT_FLAGS: '-warnings-as-errors'
        DEAD_CODE_STRIPPING: 'YES'
        SWIFT_VERSION: '6.0'
